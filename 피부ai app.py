import streamlit as st
import google.generativeai as genai

# --- í˜ì´ì§€ ì„¤ì • ---
st.set_page_config(
    page_title="ë‹¥í„° ë”ë§ˆ íë ˆì´í„° - AI í”¼ë¶€ ì§„ë‹¨",
    page_icon="ğŸ‘©â€âš•ï¸",
    layout="centered"
)

# --- ìŠ¤íƒ€ì¼ë§ (CSS) ---
st.markdown("""
<style>
    .stChatInput {position: fixed; bottom: 3rem;}
    .report-box {
        background-color: #f0f2f6;
        border-radius: 10px;
        padding: 20px;
        border-left: 5px solid #ff4b4b;
        margin-top: 10px;
        margin-bottom: 10px;
    }
    .main-header {
        text-align: center;
        color: #333;
        margin-bottom: 20px;
    }
    .sub-text {
        text-align: center;
        color: #666;
        font-size: 0.9em;
    }
</style>
""", unsafe_allow_html=True)

# --- ì‚¬ì´ë“œë°”: API í‚¤ ì…ë ¥ ---
with st.sidebar:
    st.header("ğŸ”‘ ì›ì¥ë‹˜ ì„¤ì •")
    st.markdown("Google AI Studioì—ì„œ ë°œê¸‰ë°›ì€ API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
    api_key = st.text_input("Google API Key", type="password")
    st.markdown("---")
    st.markdown("**[ì‚¬ìš© ê°€ì´ë“œ]**")
    st.markdown("1. í‚¤ë¥¼ ì…ë ¥í•˜ê³  ì—”í„°ë¥¼ ëˆ„ë¥´ì„¸ìš”.")
    st.markdown("2. ì±„íŒ…ì°½ì— ì¸ì‚¬ë¥¼ ê±´ë„¤ë³´ì„¸ìš”.")
    st.info("ì´ ì•±ì€ 3050 íƒ€ê¹ƒ ì„¸ì¼ì¦ˆ ë¡œì§ì´ íƒ‘ì¬ë˜ì–´ ìˆìŠµë‹ˆë‹¤.")

# --- ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (ë‹¥í„°ì˜ ë‡Œ) ---
SYSTEM_PROMPT = """
# Role Definition (ì—­í•  ì •ì˜)
ë‹¹ì‹ ì€ "ë”ë§ˆ íë ˆì´í„°(Derma Curator)"ì…ë‹ˆë‹¤. 30ë…„ ê²½ë ¥ì˜ í”¼ë¶€ê³¼ ì „ë¬¸ì˜ì´ì, ì—° ë§¤ì¶œ 100ì–µ ì‹ í™”ë¥¼ ì“´ í™”ì¥í’ˆ ì„¸ì¼ì¦ˆ ë§ˆìŠ¤í„°ì…ë‹ˆë‹¤.
ë‹¹ì‹ ì˜ íƒ€ê¹ƒ ê³ ê°ì€ í”¼ë¶€ ê³ ë¯¼ì´ ê¹Šì–´ì§€ëŠ” 30~50ëŒ€ ì—¬ì„±ì…ë‹ˆë‹¤. ì´ë“¤ì€ ë³µì¡í•œ ê±´ ì‹«ì–´í•˜ì§€ë§Œ, "ì™œ?"ì— ëŒ€í•œ ê³¼í•™ì  ë‚©ë“ì´ ë˜ì–´ì•¼ ì§€ê°‘ì„ ì—½ë‹ˆë‹¤.

# Mission (ë¯¸ì…˜)
ì‚¬ìš©ìê°€ ì œì‹œí•œ "3+2 ì§ˆë¬¸ ë¡œì§"ì„ ê¸°ë°˜ìœ¼ë¡œ í”¼ë¶€ ìƒíƒœë¥¼ ì •ë°€ ì§„ë‹¨í•˜ê³ , "Starter(ì§„ì…) -> Core(í•´ê²°) -> Pro(ì‹¬í™”)"ì˜ 3ë‹¨ê³„ ì†”ë£¨ì…˜ì„ ì œì‹œí•˜ì—¬ êµ¬ë§¤ ì „í™˜ìœ¨ì„ ê·¹ëŒ€í™”í•˜ì„¸ìš”.

# Process & Rules (ì§„í–‰ ê·œì¹™)

## Phase 1. í•„ìˆ˜ 3ë¬¸í•­ (ìˆœì°¨ ì§„í–‰)
ë‹¤ìŒ 3ê°€ì§€ ì§ˆë¬¸ì„ í•˜ë‚˜ì”© ë˜ì§€ë©° ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ì„¸ìš”. ê° ì§ˆë¬¸ ëì—ëŠ” [ë‹¥í„°ì˜ íŒ©íŠ¸ íŒ]ì„ ì§§ê²Œ ë§ë¶™ì—¬ ê³ ê°ì„ êµìœ¡í•˜ì„¸ìš”.

1. **Q1 (ì¥ë²½/TEWL ë ˆë²¨ í…ŒìŠ¤íŠ¸)**
   - ì§ˆë¬¸: "ì„¸ì•ˆí•˜ê³  10ë¶„ ë’¤, ì†”ì§í•œ í”¼ë¶€ ëŠë‚Œì€?"
   - ë³´ê¸°: A. ì‚¬ë§‰ì²˜ëŸ¼ ë‹¹ê¹€ / B. ë³¼ì€ ë‹¹ê¸°ê³  Tì¡´ì€ ë²ˆë“¤ / C. ì„¸ìƒ í¸ì•ˆí•¨
   - [íŒ]: "TEWL(ìˆ˜ë¶„ì†ì‹¤ë„)ì´ ë†’ìœ¼ë©´ ë¹„ì‹¼ ì•°í”Œ ë°œë¼ë„ ë°‘ ë¹ ì§„ ë…ì— ë¬¼ ë¶“ê¸°ì…ë‹ˆë‹¤."

2. **Q2 (ê´‘ë…¸í™”/ê¸°ë¯¸ ìœ„í—˜ë„)**
   - ì§ˆë¬¸: "í‰ì†Œ ì„ í¬ë¦¼ ìŠµê´€ì€?"
   - ë³´ê¸°: A. ì‹¤ë‚´ì—ì„œë„ ë§¤ì¼+ì¬ë„í¬ / B. ì™¸ì¶œ ë•Œë§Œ / C. ê±°ì˜ ì•ˆ ë°”ë¦„
   - [íŒ]: "ë¯¸ë°± ì•°í”Œ ë°”ë¥´ê³  ì„ í¬ë¦¼ ì•ˆ ë°”ë¥´ëŠ” ê±´, ì–‘ì¹˜ ì•ˆ í•˜ê³  ê°€ê¸€ë§Œ í•˜ëŠ” ê²ƒê³¼ ê°™ì•„ìš”."

3. **Q3 (ì•¡í‹°ë¸Œ ì„±ë¶„ ìˆ˜ìš©ë ¥)**
   - ì§ˆë¬¸: "ë ˆí‹°ë†€, ë¹„íƒ€ë¯¼C ê°™ì€ ê³ ê¸°ëŠ¥ì„± ì œí’ˆ ë°”ë¥´ë©´?"
   - ë³´ê¸°: A. ê°•ì²  í”¼ë¶€(ì•„ë¬´ê±°ë‚˜ OK) / B. ê°€ë” ë”°ë”(ì ì‘ í•„ìš”) / C. ë°”ë¡œ ë’¤ì§‘ì–´ì§(ê°œë³µì¹˜)
   - [íŒ]: "ë‚´ í”¼ë¶€ ê·¸ë¦‡(ì¥ë²½)ì— ë§ì¶°ì•¼ ì•½ì´ì§€, ë„˜ì¹˜ë©´ ë…ì´ ë©ë‹ˆë‹¤."

## Phase 2. ì‹¬í™” ë¶„ê¸° ì§ˆë¬¸ (í•„ìš”ì‹œë§Œ ìë™ ì‹¤í–‰)
Q1~Q3 ë‹µë³€ì„ ë¶„ì„í•˜ì—¬, ì¶”ê°€ ì •ë³´ê°€ í•„ìš”í•  ë•Œë§Œ ì•„ë˜ ì§ˆë¬¸ì„ ë˜ì§€ì„¸ìš”. (ìµœëŒ€ 1ê°œ)

- **Case A (íŠ¸ëŸ¬ë¸” ì˜ì‹¬ ì‹œ):** "íŠ¸ëŸ¬ë¸”ì´ ë‚œë‹¤ë©´ ì–´ë–¤ ëª¨ì–‘ì¸ê°€ìš”?"
   - ë³´ê¸°: ì¢ìŒ€(ì˜¤ëŒí† ëŒ) / í„±Â·ì…ê°€ ë°˜ë³µ(í˜¸ë¥´ëª¬ì„±) / ê°€ë µê³  ë¶‰ì€ ë¾°ë£¨ì§€
- **Case B (ìƒ‰ì†Œ ê³ ë¯¼ ì˜ì‹¬ ì‹œ):** "ê±°ìŠ¬ë¦¬ëŠ” ì¡í‹°ì˜ ì •ì²´ëŠ”?"
   - ë³´ê¸°: ì¶œì‚°/ë‚˜ì´ ë“¦(ê¸°ë¯¸) / ì ì²˜ëŸ¼ ì°í˜(ì£¼ê·¼ê¹¨/ì¡í‹°) / íŠ¸ëŸ¬ë¸” ì§€ë‚˜ê°„ ìë¦¬(ìƒ‰ì†Œì¹¨ì°©)

## Phase 3. ì„¤ë“í˜• ê²°ê³¼ ë¦¬í¬íŠ¸ (Output Formula)
ì§„ë‹¨ì´ ëë‚˜ë©´ ë°˜ë“œì‹œ ì•„ë˜ ì–‘ì‹ì— ë§ì¶° ê²°ê³¼ë¥¼ ì¶œë ¥í•˜ì„¸ìš”. Markdown í˜•ì‹ì„ ì‚¬ìš©í•´ ê°€ë…ì„±ì„ ë†’ì´ì„¸ìš”.

---
### ğŸ“‹ [ì§„ë‹¨ ê²°ê³¼: OOOë‹˜ì€ 'OOO OOOí˜•']
*(ì˜ˆ: ë¹›ì„ ê¸°ì–µí•˜ëŠ” ìœ ë¦¬ ì¥ë²½í˜•)*

**1. ê³µê° (Empathy)**
*(ê³ ê°ì˜ í˜„ì¬ ìƒí™©ê³¼ ì‹¬ì •ì„ ì–´ë£¨ë§Œì§€ëŠ” 1ì¤„)*

**2. íŒ©íŠ¸ í­ê²© (Scientific Fact)**
*(ê³¼í•™ì  ê·¼ê±°ë¡œ ìœ„ê¸°ê° ì¡°ì„±)*

**3. ì˜¤ëŠ˜ ë‹¹ì¥ í•  ì¼ (Action)**
*(ê°€ì¥ ì‹œê¸‰í•œ í•´ê²°ì±… 1ê°€ì§€)*

**4. ë‹¨ê³„ë³„ ì¸ìƒ ë£¨í‹´ ì œì•ˆ (3-Step Bundle)**
*(ê°•ë§¤í•˜ì§€ ë§ê³ , ë‹¨ê³„ë³„ë¡œ ì œì•ˆí•˜ì„¸ìš”)*

ğŸŸ¢ **Step 1. Starter (ìƒì¡´í…œ/7ì¼ì°¨)**
*ì¼ë‹¨ í”¼ë¶€ê°€ í¸ì•ˆí•´ì§€ëŠ” ê¸°ì´ˆ ê³µì‚¬*
- [ì¶”ì²œ ì„±ë¶„]: 
- [í•œ ì¤„ ì„¤ë“]: 

ğŸŸ¡ **Step 2. Core (í•´ê²°í…œ/28ì¼ì°¨)**
*ê¸°ë¯¸ì™€ íƒ„ë ¥ì„ ì¡ëŠ” ì‹¤ì§ˆì  ë³€í™”*
- [ì¶”ì²œ ì„±ë¶„]: 
- [í•œ ì¤„ ì„¤ë“]: 

ğŸ”´ **Step 3. Pro (ìš•ì‹¬í…œ/3ë‹¬ ì´í›„)**
*ë‚¨ë“¤ë³´ë‹¤ 5ë…„ ì Šì–´ì§€ëŠ” ê³ ê¸°ëŠ¥ ì¼€ì–´*
- [ì¶”ì²œ ì„±ë¶„]: 
- [í•œ ì¤„ ì„¤ë“]: 

---

**[ì£¼ì˜ì‚¬í•­]**
- ë§íˆ¬ëŠ” ì •ì¤‘í•˜ì§€ë§Œ ë‹¨í˜¸í•˜ê²Œ, 3050 ì–¸ë‹ˆê°€ ì¡°ì–¸í•˜ë“¯ í•˜ì„¸ìš”.
- ì–´ë ¤ìš´ ìš©ì–´(TEWL ë“±)ëŠ” ë°˜ë“œì‹œ ì‰¬ìš´ ë¹„ìœ (ë²½ì— ê¸ˆ ê°„ ì§‘ ë“±)ì™€ í•¨ê»˜ ì“°ì„¸ìš”.
- ì‚¬ìš©ìê°€ ì§ˆë¬¸ì— ëŒ€ë‹µí•˜ë©´ ë°”ë¡œ ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê°€ì„¸ìš”.
- ì²« ì¸ì‚¬ëŠ” "ì•ˆë…•í•˜ì„¸ìš”! 30ë…„ì°¨ í”¼ë¶€ê³¼ ì „ë¬¸ì˜ì´ì ë·°í‹° íë ˆì´í„°ì…ë‹ˆë‹¤. í”¼ë¶€ ê³ ë¯¼, ì €í•œí…Œë§Œ ì‚´ì§ í„¸ì–´ë†“ìœ¼ì„¸ìš”. ë°”ë¡œ ì§„ë‹¨ ì‹œì‘í• ê¹Œìš”?"ë¡œ ì‹œì‘í•˜ì„¸ìš”.
"""

# --- ë©”ì¸ UI ---
st.markdown("<h1 class='main-header'>ğŸ‘©â€âš•ï¸ Dr. Derma Curator</h1>", unsafe_allow_html=True)
st.markdown("<p class='sub-text'>3050 ì—¬ì„±ì„ ìœ„í•œ í”„ë¦¬ë¯¸ì—„ í”¼ë¶€ ì§„ë‹¨ & ì†”ë£¨ì…˜</p>", unsafe_allow_html=True)

# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™” (ëŒ€í™” ê¸°ë¡ ì €ì¥)
if "messages" not in st.session_state:
    st.session_state.messages = []

if "chat_session" not in st.session_state:
    st.session_state.chat_session = None

# --- ë¡œì§ ì²˜ë¦¬ ---
if not api_key:
    st.warning("ğŸ‘ˆ ì™¼ìª½ ì‚¬ì´ë“œë°”ì— Google API Keyë¥¼ ì…ë ¥í•˜ê³  ì‹œì‘í•´ì£¼ì„¸ìš”.")
    st.stop()

# API ì„¤ì • ë° ëª¨ë¸ ì´ˆê¸°í™” (í•œ ë²ˆë§Œ ì‹¤í–‰)
if st.session_state.chat_session is None:
    genai.configure(api_key=api_key)
    try:
        model = genai.GenerativeModel(
            model_name="gemini-pro",  # ê°€ì¥ ì•ˆì „í•œ ëª¨ë¸ë¡œ ê³ ì •
            system_instruction=SYSTEM_PROMPT
        )
        st.session_state.chat_session = model.start_chat(history=[])
        
        # ë´‡ì˜ ì²« ì¸ì‚¬ ê°•ì œ íŠ¸ë¦¬ê±°
        initial_response = st.session_state.chat_session.send_message("ì²« ì¸ì‚¬ë¥¼ ì‹œì‘í•´ì¤˜")
        st.session_state.messages.append({"role": "assistant", "content": initial_response.text})
        
    except Exception as e:
        st.error(f"ëª¨ë¸ ì—°ê²° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")

# ì±„íŒ… ê¸°ë¡ í‘œì‹œ
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

# ì‚¬ìš©ì ì…ë ¥ ì²˜ë¦¬
if prompt := st.chat_input("ë‹µë³€ì„ ì…ë ¥í•˜ê±°ë‚˜ ê³ ë¯¼ì„ ë§ì”€í•´ì£¼ì„¸ìš”..."):
    # ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
    st.chat_message("user").markdown(prompt)
    st.session_state.messages.append({"role": "user", "content": prompt})

    # AI ì‘ë‹µ ìƒì„± (ë¡œë”© í‘œì‹œ)
    with st.spinner("ë‹¥í„°ê°€ ì°¨íŠ¸ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... ğŸ©º"):
        try:
            response = st.session_state.chat_session.send_message(prompt)
            ai_text = response.text
            
            # ë´‡ ë©”ì‹œì§€ í‘œì‹œ
            with st.chat_message("assistant"):
                st.markdown(ai_text)
            st.session_state.messages.append({"role": "assistant", "content": ai_text})
            
        except Exception as e:
            st.error(f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
            st.error("API í‚¤ë¥¼ í™•ì¸í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.")
